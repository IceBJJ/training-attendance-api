<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reports</title>
  <style>
    :root {
      --bg: #0f1411;
      --panel: #161c19;
      --text: #e9f3ed;
      --muted: #9fb0a6;
      --border: #2b3a32;
      --accent: #79d498;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      color: var(--text);
      background: var(--bg);
      padding: 24px;
    }
    .wrap { max-width: 960px; margin: 0 auto; }
    h1 { margin: 0 0 8px; }
    p { color: var(--muted); margin: 0 0 16px; }
    button {
      background: linear-gradient(120deg, var(--accent), #58b87b);
      color: #0d140f;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 8px;
    }
    .msg {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #111815;
      white-space: pre-wrap;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      margin-top: 12px;
    }
    th, td {
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 14px;
    }
    th { color: var(--muted); font-weight: 600; }
    select {
      width: 100%;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #1d2622;
      color: var(--text);
    }
    a { color: var(--accent); text-decoration: none; }
    .home-link { margin-bottom: 12px; }
    .home-link a {
      display: inline-block;
      padding: 8px 12px;
      border-radius: 10px;
      background: var(--panel);
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      border: 1px solid var(--border);
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="home-link">
    <a href="/home">‚Üê Home</a>
  </div>
  <div class="wrap">
    <h1>Reports <span style="font-size:12px;opacity:0.6;">v1.0.2</span></h1>
    <p>Read-only reports (no password required).</p>

    <label>Facility</label>
    <select id="facilitySelect"></select>

    <!-- Summary actions -->
    <button onclick="loadSummary()">Load Member Summary</button>
    <button onclick="exportSummary()">Export Summary CSV</button>
    <div id="msg" class="msg"></div>
    <div id="summary"></div>

    <label>Member detail</label>
    <select id="memberSelect"></select>
    <button onclick="loadDetail()">Load Member Detail</button>
    <button onclick="exportDetail()">Export Member CSV</button>
    <div id="detail"></div>

    <h2 style="margin-top:16px;">Attendance by Facility</h2>
    <button onclick="loadAttendanceByFacility()">Load Attendance Summary</button>
    <button onclick="exportAttendanceByFacility()">Export Attendance CSV</button>
    <div id="attendanceSummary"></div>
  </div>

  <script>
    const msg = document.getElementById("msg");
    const summary = document.getElementById("summary");
    const memberSelect = document.getElementById("memberSelect");
    const detail = document.getElementById("detail");
    const facilitySelect = document.getElementById("facilitySelect");
    const attendanceSummary = document.getElementById("attendanceSummary");

    function setMsg(text) {
      msg.textContent = text;
    }

    // Fetch and render the summary report.
    function facilityQuery() {
      const val = facilitySelect.value;
      return val ? `?facility_id=${encodeURIComponent(val)}` : "";
    }

    async function loadSummary() {
      try {
        const res = await fetch(`/reports/members-summary${facilityQuery()}`);
        const data = await res.json();
        if (!res.ok) throw new Error("Load failed");
        setMsg(`Loaded ${data.length} members.`);
        renderSummary(data);
        detail.innerHTML = "";
      } catch (e) {
        setMsg(String(e));
      }
    }

    function renderSummary(rows) {
      summary.innerHTML = "";
      memberSelect.innerHTML = "";
      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th>Name</th>
            <th>Belt</th>
            <th>Sessions Since Promotion</th>
            <th>Months Since Promotion</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");
      rows.forEach((r) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.last_name}, ${r.first_name}</td>
          <td>${r.belt_rank || ""}</td>
          <td>${r.sessions_since_promotion}</td>
          <td>${r.months_since_promotion ?? ""}</td>
        `;
        tbody.appendChild(tr);

        const opt = document.createElement("option");
        opt.value = r.id;
        opt.textContent = `${r.first_name} ${r.last_name}`;
        memberSelect.appendChild(opt);
      });
      summary.appendChild(table);
    }

    // Fetch and render a single member detail report.
    async function loadDetail() {
      const id = memberSelect.value;
      if (!id) return;
      try {
        const res = await fetch(`/reports/member/${encodeURIComponent(id)}${facilityQuery()}`);
        const data = await res.json();
        if (!res.ok) throw new Error("Load failed");
        renderDetail(data);
      } catch (e) {
        detail.innerHTML = `<div class="msg">${String(e)}</div>`;
      }
    }

    function renderDetail(data) {
      const monthly = data.sessions_by_month || [];
      let rows = "";
      monthly.forEach((m) => {
        rows += `<tr><td>${m.month}</td><td>${m.sessions}</td></tr>`;
      });
      detail.innerHTML = `
        <div class="msg">
          Total sessions since promotion: ${data.sessions_since_promotion}\n
          Months since promotion: ${data.months_since_promotion ?? "N/A"}
        </div>
        <table>
          <thead><tr><th>Month</th><th>Sessions</th></tr></thead>
          <tbody>${rows || "<tr><td colspan='2'>No sessions</td></tr>"}</tbody>
        </table>
      `;
    }

    function exportSummary() {
      window.open(`/reports/members-summary.csv${facilityQuery()}`, "_blank");
    }

    function exportDetail() {
      const id = memberSelect.value;
      if (!id) return;
      window.open(`/reports/member/${encodeURIComponent(id)}.csv${facilityQuery()}`, "_blank");
    }

    async function loadAttendanceByFacility() {
      try {
        const res = await fetch("/reports/attendance-by-facility");
        const data = await res.json();
        if (!res.ok) throw new Error("Load failed");
        renderAttendanceByFacility(data);
      } catch (e) {
        attendanceSummary.innerHTML = `<div class="msg">${String(e)}</div>`;
      }
    }

    function renderAttendanceByFacility(rows) {
      attendanceSummary.innerHTML = "";
      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th>Member</th>
            <th>Facility</th>
            <th>Sessions</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");
      rows.forEach((r) => {
        const name = r.first_name || r.last_name ? `${r.last_name || ""}, ${r.first_name || ""}` : r.user_id;
        const facility = r.facility_name || r.facility_id || "";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${name}</td>
          <td>${facility}</td>
          <td>${r.sessions}</td>
        `;
        tbody.appendChild(tr);
      });
      attendanceSummary.appendChild(table);
    }

    function exportAttendanceByFacility() {
      window.open("/reports/attendance-by-facility.csv", "_blank");
    }

    async function loadFacilities() {
      const res = await fetch("/facilities");
      const data = await res.json();
      facilitySelect.innerHTML = "";
      const all = document.createElement("option");
      all.value = "";
      all.textContent = "All facilities";
      facilitySelect.appendChild(all);
      data.forEach((f) => {
        const opt = document.createElement("option");
        opt.value = f.id;
        opt.textContent = f.name;
        facilitySelect.appendChild(opt);
      });
    }

    facilitySelect.addEventListener("change", loadSummary);
    loadFacilities();
  </script>
</body>
</html>
