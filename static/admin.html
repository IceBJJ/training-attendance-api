<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BJJ Admin</title>
  <style>
    :root {
      --bg: #0f1411;
      --panel: #161c19;
      --panel-2: #1c2420;
      --text: #e9f3ed;
      --muted: #a6b6ab;
      --accent: #79d498;
      --accent-2: #d4a15d;
      --danger: #e27171;
      --border: #2b3a32;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      color: var(--text);
      background:
        radial-gradient(800px 500px at 10% 10%, rgba(121, 212, 152, 0.12), transparent),
        radial-gradient(800px 500px at 90% 20%, rgba(212, 161, 93, 0.08), transparent),
        var(--bg);
      padding: 24px;
    }
    h1 { margin: 0 0 6px; font-size: 28px; letter-spacing: 0.4px; }
    h2 { margin: 20px 0 10px; font-size: 20px; }
    p { margin: 0 0 14px; color: var(--muted); }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    label { display: block; margin-top: 10px; font-size: 13px; color: var(--muted); }
    input, select, button, textarea {
      width: 100%;
      margin-top: 6px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--panel-2);
      color: var(--text);
      font-size: 14px;
    }
    textarea { min-height: 70px; resize: vertical; }
    button {
      background: linear-gradient(120deg, var(--accent), #57b87a);
      color: #0d140f;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }
    button.secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
    }
    .row { display: flex; gap: 10px; }
    .row > * { flex: 1; }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(121, 212, 152, 0.2);
      color: var(--accent);
      font-size: 12px;
      margin-left: 8px;
    }
    .msg {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #111815;
      white-space: pre-wrap;
    }
    .ok { border-color: rgba(121, 212, 152, 0.6); }
    .bad { border-color: rgba(226, 113, 113, 0.7); }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 10px;
    }
    th, td {
      border-bottom: 1px solid var(--border);
      padding: 8px 6px;
      text-align: left;
    }
    th { color: var(--muted); font-weight: 600; }
    a { color: var(--accent); text-decoration: none; }
    .small { font-size: 12px; color: var(--muted); }
    .home-link { margin-bottom: 12px; }
    .home-link a {
      display: inline-block;
      padding: 8px 12px;
      border-radius: 10px;
      background: var(--panel-2);
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      border: 1px solid var(--border);
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="home-link">
    <a href="/home"><- Home</a>
  </div>
  <h1>IceBJJ Admin <span class="tag">Maintenance</span></h1>
  <p>Manage facilities, members, and reports. Password is required for changes.</p>

  <div class="panel">
    <h2>Admin Access</h2>
    <div class="row">
      <input id="adminPass" type="password" placeholder="Admin password" />
      <button onclick="unlock()">Unlock</button>
      <button class="secondary" onclick="lock()">Lock</button>
    </div>
    <div id="authMsg" class="msg">Locked.</div>
  </div>

  <!-- Admin actions and reports -->
  <div class="grid">
    <div class="panel">
      <h2>Add Facility + QR</h2>
      <label>Facility name</label>
      <input id="facName" placeholder="Findlay BJJ" />
      <label>Address</label>
      <input id="facAddress" placeholder="123 Main St" />
      <label>Active</label>
      <select id="facActive">
        <option value="1">Active</option>
        <option value="0">Inactive</option>
      </select>
      <label>Facility ID (optional)</label>
      <input id="facId" placeholder="FAC_FINDLAY_BJJ" />
      <label>QR value (optional)</label>
      <input id="facQr" placeholder="QR_FAC_FINDLAY_BJJ" />
      <div class="small">If blank, IDs and QR are auto-generated.</div>
      <button onclick="createFacility()">Create Facility</button>
      <div id="facMsg" class="msg"></div>
    </div>

    <div class="panel">
      <h2>Edit/Disable Facility</h2>
      <label>Facility</label>
      <select id="facSelect"></select>
      <div id="facCurrent" class="small"></div>
      <label>New name</label>
      <input id="facEditName" placeholder="Leave blank to keep" />
      <label>New address</label>
      <input id="facEditAddress" placeholder="Leave blank to keep" />
      <label>Active</label>
      <select id="facEditActive">
        <option value="">No change</option>
        <option value="1">Active</option>
        <option value="0">Inactive</option>
      </select>
      <button onclick="updateFacility()">Update Facility</button>
      <div id="facEditMsg" class="msg"></div>
    </div>

    <div class="panel">
      <h2>Add Member</h2>
      <div class="row">
        <div>
          <label>First name</label>
          <input id="memFirst" />
        </div>
        <div>
          <label>Last name</label>
          <input id="memLast" />
        </div>
      </div>
      <label>Phone</label>
      <input id="memPhone" />
      <label>Address</label>
      <input id="memAddress" />
      <label>Belt rank</label>
      <input id="memBelt" placeholder="Blue" />
      <label>Promotion start date</label>
      <input id="memPromo" placeholder="MM/DD/YYYY" />
      <label>Student type</label>
      <select id="memType">
        <option value="adult">Adult</option>
        <option value="youth">Youth</option>
      </select>
      <label>Active</label>
      <select id="memActive">
        <option value="1">Active</option>
        <option value="0">Inactive</option>
      </select>
      <button onclick="createMember()">Add Member</button>
      <div id="memMsg" class="msg"></div>
    </div>

    <div class="panel">
      <h2>Edit/Disable Member</h2>
      <label>Member</label>
      <select id="memSelect"></select>
      <div id="memCurrent" class="small"></div>
      <label>First name</label>
      <input id="memEditFirst" />
      <label>Last name</label>
      <input id="memEditLast" />
      <label>Phone</label>
      <input id="memEditPhone" />
      <label>Address</label>
      <input id="memEditAddress" />
      <label>Belt rank</label>
      <input id="memEditBelt" />
      <label>Promotion start date</label>
      <input id="memEditPromo" />
      <label>Student type</label>
      <select id="memEditType">
        <option value="">No change</option>
        <option value="adult">Adult</option>
        <option value="youth">Youth</option>
      </select>
      <label>Active</label>
      <select id="memEditActive">
        <option value="">No change</option>
        <option value="1">Active</option>
        <option value="0">Inactive</option>
      </select>
      <button onclick="updateMember()">Update Member</button>
      <div id="memEditMsg" class="msg"></div>
    </div>

    <div class="panel">
      <h2>Reports</h2>
      <button onclick="loadSummary()">Load Member Summary</button>
      <button class="secondary" onclick="exportSummary()">Export Summary CSV</button>
      <div id="reportMsg" class="msg"></div>
      <div id="summaryWrap"></div>
      <label>Member detail</label>
      <select id="memberSelect"></select>
      <button class="secondary" onclick="loadMemberDetail()">Load Member Detail</button>
      <button class="secondary" onclick="exportMemberDetail()">Export Member CSV</button>
      <div id="memberDetail"></div>
    </div>

    <div class="panel">
      <h2>QR Print Pages</h2>
      <button onclick="loadQrLinks()">Load Facilities</button>
      <div id="qrLinks"></div>
    </div>
  </div>

  <script>
    const authMsg = document.getElementById("authMsg");
    const reportMsg = document.getElementById("reportMsg");
    const summaryWrap = document.getElementById("summaryWrap");
    const memberSelect = document.getElementById("memberSelect");
    const memberDetail = document.getElementById("memberDetail");
    const facSelect = document.getElementById("facSelect");
    const memSelect = document.getElementById("memSelect");
    const memPhoneInput = document.getElementById("memPhone");
    const memEditPhoneInput = document.getElementById("memEditPhone");
    const facAddressInput = document.getElementById("facAddress");
    const facEditAddressInput = document.getElementById("facEditAddress");
    const memAddressInput = document.getElementById("memAddress");
    const memEditAddressInput = document.getElementById("memEditAddress");
    const facCurrent = document.getElementById("facCurrent");
    const memCurrent = document.getElementById("memCurrent");
    let facilityCache = [];
    let memberCache = [];

    function setMsg(el, text, ok=null) {
      el.textContent = text;
      el.classList.remove("ok", "bad");
      if (ok === true) el.classList.add("ok");
      if (ok === false) el.classList.add("bad");
    }

    // Password is stored per-session so refresh clears it.
    function getPassword() {
      return sessionStorage.getItem("admin_password") || "";
    }

    // Attach admin header to protected API calls.
    function authHeaders() {
      return { "X-Admin-Password": getPassword() };
    }

    async function unlock() {
      const pass = document.getElementById("adminPass").value.trim();
      if (!pass) return setMsg(authMsg, "Enter a password.", false);
      sessionStorage.setItem("admin_password", pass);
      setMsg(authMsg, "Checking password...", null);
      try {
        const res = await fetch("/admin/ping", { headers: authHeaders() });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.detail || "Password check failed.");
        }
        setMsg(authMsg, "Unlocked.", true);
        await loadFacilities();
        await loadMembers();
        await loadReportMembers();
      } catch (e) {
        setMsg(authMsg, String(e), false);
      }
    }

    function lock() {
      sessionStorage.removeItem("admin_password");
      setMsg(authMsg, "Locked.", false);
    }

    function slugify(s) {
      return String(s || "")
        .trim()
        .toUpperCase()
        .replace(/[^A-Z0-9]+/g, "_")
        .replace(/_+/g, "_")
        .replace(/^_+|_+$/g, "");
    }

    // Facility + location creation in one step.
    async function createFacility() {
      const name = document.getElementById("facName").value.trim();
      if (!name) return setMsg(document.getElementById("facMsg"), "Facility name required.", false);
      const idInput = document.getElementById("facId").value.trim();
      const facilityId = idInput || `FAC_${slugify(name)}`;
      const payload = {
        id: idInput || null,
        name: name,
        address: document.getElementById("facAddress").value.trim() || null,
        active: Number(document.getElementById("facActive").value),
        create_location: true,
        location_id: `LOC_${facilityId.replace(/^FAC_/, "")}_CHECKIN`,
        location_name: "Check-in",
        location_description: "Facility check-in QR",
        qr_value: document.getElementById("facQr").value.trim() || `QR_${facilityId}`
      };

      try {
        const res = await fetch("/admin/facilities", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || "Create failed");
        setMsg(document.getElementById("facMsg"), `Created ${data.facility.id}\nQR: ${data.location ? data.location.qr_value : ""}`, true);
      } catch (e) {
        setMsg(document.getElementById("facMsg"), String(e), false);
      }
    }

    // Member creation.
    async function createMember() {
      const payload = {
        first_name: document.getElementById("memFirst").value.trim(),
        last_name: document.getElementById("memLast").value.trim(),
        phone: document.getElementById("memPhone").value.trim() || null,
        address: document.getElementById("memAddress").value.trim() || null,
        belt_rank: document.getElementById("memBelt").value.trim() || null,
        promotion_start_date: normalizeDate(document.getElementById("memPromo").value),
        student_type: document.getElementById("memType").value,
        active: Number(document.getElementById("memActive").value)
      };
      try {
        const res = await fetch("/admin/members", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || "Create failed");
        setMsg(document.getElementById("memMsg"), `Member created: ${data.member_id}`, true);
      } catch (e) {
        setMsg(document.getElementById("memMsg"), String(e), false);
      }
    }

    // Update facility fields (including Active flag).
    async function updateFacility() {
      const id = facSelect.value;
      if (!id) return setMsg(document.getElementById("facEditMsg"), "Pick a facility.", false);
      const payload = {};
      const name = document.getElementById("facEditName").value.trim();
      const address = document.getElementById("facEditAddress").value.trim();
      const active = document.getElementById("facEditActive").value;
      if (name) payload.name = name;
      if (address) payload.address = address;
      if (active !== "") payload.active = Number(active);

      try {
        const res = await fetch(`/admin/facilities/${encodeURIComponent(id)}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || "Update failed");
        setMsg(document.getElementById("facEditMsg"), "Facility updated.", true);
        await loadFacilities();
      } catch (e) {
        setMsg(document.getElementById("facEditMsg"), String(e), false);
      }
    }

    // Update member fields (including Active flag).
    async function updateMember() {
      const id = memSelect.value;
      if (!id) return setMsg(document.getElementById("memEditMsg"), "Pick a member.", false);
      const payload = {};
      const first = document.getElementById("memEditFirst").value.trim();
      const last = document.getElementById("memEditLast").value.trim();
      const phone = document.getElementById("memEditPhone").value.trim();
      const address = document.getElementById("memEditAddress").value.trim();
      const belt = document.getElementById("memEditBelt").value.trim();
      const promo = normalizeDate(document.getElementById("memEditPromo").value);
      const studentType = document.getElementById("memEditType").value;
      const active = document.getElementById("memEditActive").value;
      if (first) payload.first_name = first;
      if (last) payload.last_name = last;
      if (phone) payload.phone = phone;
      if (address) payload.address = address;
      if (belt) payload.belt_rank = belt;
      if (promo) payload.promotion_start_date = promo;
      if (studentType) payload.student_type = studentType;
      if (active !== "") payload.active = Number(active);

      try {
        const res = await fetch(`/admin/members/${encodeURIComponent(id)}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || "Update failed");
        setMsg(document.getElementById("memEditMsg"), "Member updated.", true);
        await loadMembers();
      } catch (e) {
        setMsg(document.getElementById("memEditMsg"), String(e), false);
      }
    }

    // Summary report (sessions and months since promotion).
    async function loadSummary() {
      try {
        const res = await fetch("/admin/reports/members-summary", { headers: authHeaders() });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || "Load failed");
        setMsg(reportMsg, `Loaded ${data.length} members.`, true);
        renderSummary(data);
      } catch (e) {
        setMsg(reportMsg, String(e), false);
      }
    }

    function renderSummary(rows) {
      summaryWrap.innerHTML = "";
      memberSelect.innerHTML = "";

      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th>Name</th>
            <th>Belt</th>
            <th>Sessions Since Promotion</th>
            <th>Months Since Promotion</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");
      rows.forEach((r) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.last_name}, ${r.first_name}</td>
          <td>${r.belt_rank || ""}</td>
          <td>${r.sessions_since_promotion}</td>
          <td>${r.months_since_promotion ?? ""}</td>
        `;
        tbody.appendChild(tr);

        addMemberOption(memberSelect, r.id, `${r.first_name} ${r.last_name}`);
      });
      summaryWrap.appendChild(table);
    }

    // Detailed report for a single member.
    async function loadMemberDetail() {
      const id = memberSelect.value;
      if (!id) return;
      try {
        const res = await fetch(`/admin/reports/member/${encodeURIComponent(id)}`, { headers: authHeaders() });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || "Load failed");
        renderMemberDetail(data);
      } catch (e) {
        memberDetail.innerHTML = `<div class="msg bad">${String(e)}</div>`;
      }
    }

    function renderMemberDetail(data) {
      const monthly = data.sessions_by_month || [];
      let rows = "";
      monthly.forEach((m) => {
        rows += `<tr><td>${m.month}</td><td>${m.sessions}</td></tr>`;
      });
      memberDetail.innerHTML = `
        <div class="msg ok">
          Total sessions since promotion: ${data.sessions_since_promotion}\n
          Months since promotion: ${data.months_since_promotion ?? "N/A"}
        </div>
        <table>
          <thead><tr><th>Month</th><th>Sessions</th></tr></thead>
          <tbody>${rows || "<tr><td colspan='2'>No sessions</td></tr>"}</tbody>
        </table>
      `;
    }

    async function exportSummary() {
      try {
        const res = await fetch("/admin/reports/members-summary.csv", { headers: authHeaders() });
        if (!res.ok) throw new Error("Export failed");
        const blob = await res.blob();
        downloadBlob(blob, "members_summary.csv");
      } catch (e) {
        setMsg(reportMsg, String(e), false);
      }
    }

    async function exportMemberDetail() {
      const id = memberSelect.value;
      if (!id) return;
      try {
        const res = await fetch(`/admin/reports/member/${encodeURIComponent(id)}.csv`, { headers: authHeaders() });
        if (!res.ok) throw new Error("Export failed");
        const blob = await res.blob();
        downloadBlob(blob, `member_${id}.csv`);
      } catch (e) {
        memberDetail.innerHTML = `<div class="msg bad">${String(e)}</div>`;
      }
    }

    // Populate admin facility dropdown.
    async function loadFacilities() {
      facSelect.innerHTML = "";
      const res = await fetch("/admin/facilities", { headers: authHeaders() });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        setMsg(document.getElementById("facEditMsg"), data.detail || "Failed to load facilities.", false);
        return;
      }
      const data = await res.json();
      facilityCache = data;
      if (!data.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No facilities found";
        facSelect.appendChild(opt);
        return;
      }
      data.forEach((f) => {
        const opt = document.createElement("option");
        opt.value = f.id;
        opt.textContent = `${f.name} (${f.id})`;
        facSelect.appendChild(opt);
      });
      fillFacilityFields();
    }

    // Populate admin member dropdown.
    async function loadMembers() {
      memSelect.innerHTML = "";
      const res = await fetch("/admin/members", { headers: authHeaders() });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        setMsg(document.getElementById("memEditMsg"), data.detail || "Failed to load members.", false);
        return;
      }
      const data = await res.json();
      memberCache = data;
      data.forEach((m) => {
        addMemberOption(memSelect, m.id, `${m.first_name} ${m.last_name}`);
      });
      fillMemberFields();
    }

    // Populate reports dropdown.
    async function loadReportMembers() {
      memberSelect.innerHTML = "";
      const res = await fetch("/admin/members", { headers: authHeaders() });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        setMsg(reportMsg, data.detail || "Failed to load members for report.", false);
        return;
      }
      const data = await res.json();
      if (!data.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No members found";
        memberSelect.appendChild(opt);
        return;
      }
      data.forEach((m) => {
        addMemberOption(memberSelect, m.id, `${m.first_name} ${m.last_name}`);
      });
    }

    function addMemberOption(select, id, label) {
      const opt = document.createElement("option");
      opt.value = id;
      opt.textContent = label;
      select.appendChild(opt);
    }

    function fillFacilityFields() {
      const id = facSelect.value;
      const fac = facilityCache.find((f) => f.id === id);
      if (!fac) return;
      document.getElementById("facEditName").value = fac.name || "";
      document.getElementById("facEditAddress").value = formatAddress(fac.address);
      document.getElementById("facEditActive").value = String(fac.active ?? "");
      facCurrent.textContent = `Current: ${fac.name || ""}${fac.address ? " - " + formatAddress(fac.address) : ""}`;
    }

    function fillMemberFields() {
      const id = memSelect.value;
      const mem = memberCache.find((m) => m.id === id);
      if (!mem) return;
      document.getElementById("memEditFirst").value = mem.first_name || "";
      document.getElementById("memEditLast").value = mem.last_name || "";
      document.getElementById("memEditPhone").value = formatPhone(mem.phone);
      document.getElementById("memEditAddress").value = formatAddress(mem.address);
      document.getElementById("memEditBelt").value = mem.belt_rank || "";
      document.getElementById("memEditPromo").value = formatDate(mem.promotion_start_date);
      document.getElementById("memEditType").value = mem.student_type || "";
      document.getElementById("memEditActive").value = String(mem.active ?? "");
      const phoneLabel = mem.phone ? ` - ${formatPhone(mem.phone)}` : "";
      const promoLabel = mem.promotion_start_date ? ` - ${formatDate(mem.promotion_start_date)}` : "";
      const addrLabel = mem.address ? ` - ${formatAddress(mem.address)}` : "";
      memCurrent.textContent = `Current: ${mem.first_name || ""} ${mem.last_name || ""}${phoneLabel}${promoLabel}${addrLabel}`;
    }

    function formatPhone(value) {
      const digits = String(value || "").replace(/\D+/g, "");
      if (digits.length === 7) {
        return `${digits.slice(0,3)}-${digits.slice(3)}`;
      }
      if (digits.length === 10) {
        return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
      }
      return value || "";
    }

    function formatPhonePartial(value) {
      const digits = String(value || "").replace(/\D+/g, "");
      if (digits.length <= 3) return digits;
      if (digits.length <= 6) return `${digits.slice(0,3)}-${digits.slice(3)}`;
      if (digits.length <= 10) {
        const area = digits.slice(0,3);
        const mid = digits.slice(3,6);
        const tail = digits.slice(6);
        return `(${area}) ${mid}-${tail}`;
      }
      return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6,10)}`;
    }

    function formatDate(value) {
      if (!value) return "";
      const parts = String(value).split("T")[0].split("-");
      if (parts.length === 3) {
        return `${parts[1]}/${parts[2]}/${parts[0]}`;
      }
      return value;
    }

    function normalizeDate(value) {
      const v = String(value || "").trim();
      if (!v) return "";
      const m = v.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (m) {
        const mm = m[1].padStart(2, "0");
        const dd = m[2].padStart(2, "0");
        return `${m[3]}-${mm}-${dd}`;
      }
      return v;
    }

    function formatAddress(value) {
      const raw = String(value || "").trim();
      if (!raw) return "";
      const spaced = raw.replace(/\s+/g, " ").replace(/\s*,\s*/g, ", ");
      const stateZipMatch = spaced.match(/^(.*?)(?:,\s*)?([A-Za-z]{2})\s+(\d{5}(?:-\d{4})?)$/);

      const titleCase = (segment) => {
        return segment.split(" ").map((word) => {
          if (!word) return word;
          const bare = word.replace(/[^A-Za-z0-9]/g, "");
          if (/^\d+$/.test(bare)) return word;
          if (/^[A-Za-z]{2}$/.test(bare)) return word.toUpperCase();
          const lower = word.toLowerCase();
          return lower.charAt(0).toUpperCase() + lower.slice(1);
        }).join(" ");
      };

      if (stateZipMatch) {
        const left = titleCase(stateZipMatch[1].trim()).replace(/\s*,\s*/g, ", ");
        const state = stateZipMatch[2].toUpperCase();
        const zip = stateZipMatch[3];
        return left ? `${left}, ${state} ${zip}` : `${state} ${zip}`;
      }

      return titleCase(spaced);
    }

    function formatAddressPartial(value) {
      const raw = String(value || "");
      if (raw.endsWith(" ")) {
        return raw;
      }
      return formatAddress(raw);
    }

    facSelect.addEventListener("change", fillFacilityFields);
    memSelect.addEventListener("change", fillMemberFields);

    function bindPhoneInput(input) {
      if (!input) return;
      const format = () => { input.value = formatPhonePartial(input.value); };
      input.addEventListener("input", format);
      input.addEventListener("change", format);
      input.addEventListener("blur", format);
      format();
    }

    bindPhoneInput(memPhoneInput);
    bindPhoneInput(memEditPhoneInput);

    function bindAddressInput(input) {
      if (!input) return;
      const format = () => { input.value = formatAddressPartial(input.value); };
      input.addEventListener("change", format);
      input.addEventListener("blur", format);
      format();
    }

    bindAddressInput(facAddressInput);
    bindAddressInput(facEditAddressInput);
    bindAddressInput(memAddressInput);
    bindAddressInput(memEditAddressInput);

    async function loadQrLinks() {
      const container = document.getElementById("qrLinks");
      container.innerHTML = "";
      try {
        const [facRes, locRes] = await Promise.all([
          fetch("/facilities"),
          fetch("/locations")
        ]);
        const facs = await facRes.json();
        const locs = await locRes.json();
        const locByFacility = {};
        locs.forEach((l) => { locByFacility[l.facility_id] = l; });

        facs.forEach((f) => {
          const loc = locByFacility[f.id];
          const div = document.createElement("div");
          div.className = "msg";
          div.innerHTML = `
            <strong>${f.name}</strong><br/>
            QR: ${loc ? loc.qr_value : "Missing"}<br/>
            <a href="/qr/${encodeURIComponent(f.id)}" target="_blank">Print QR</a>
          `;
          container.appendChild(div);
        });
      } catch (e) {
        container.innerHTML = `<div class="msg bad">${String(e)}</div>`;
      }
    }

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>

