<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BJJ Check-In</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; max-width: 520px; margin: 0 auto; }
    h2 { margin: 8px 0 16px; }
    label { display:block; margin-top: 10px; font-weight: 600; }
    input, button { font-size: 18px; padding: 10px; width: 100%; margin-top: 6px; box-sizing: border-box; }
    button { cursor: pointer; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .msg { margin-top: 12px; padding: 12px; border-radius: 10px; border: 1px solid #ddd; white-space: pre-wrap; }
    #reader { margin-top: 14px; }
    .small { font-size: 13px; opacity: 0.8; margin-top: 10px; }
    .ok { border-color: #b7e4c7; }
    .bad { border-color: #f4acb7; }
    .home-link { margin-bottom: 12px; }
    .home-link a {
      display: inline-block;
      padding: 8px 12px;
      border-radius: 10px;
      background: #f5f5f5;
      color: #222;
      text-decoration: none;
      font-weight: 600;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <div class="home-link">
    <a href="/home">‚Üê Home</a>
  </div>
  <h2>BJJ Check-In</h2>

  <div class="row">
    <div>
      <label>First name</label>
      <input id="first" placeholder="First" />
    </div>
    <div>
      <label>Last name</label>
      <input id="last" placeholder="Last" />
    </div>
  </div>

  <label>Phone (optional)</label>
  <input id="phone" placeholder="4195551234" />
  <div class="small">Country code is OK; we use the last 10 digits.</div>

  <button onclick="saveIdentity()">Save name on this phone</button>
  <button onclick="validateMember()">Validate membership</button>

  <button onclick="startScan()">Scan QR</button>
  <button onclick="stopScan()">Stop scan</button>

  <div id="out" class="msg">Enter your name, tap Save, then Scan QR.</div>

  <div id="reader"></div>

  <div class="small">
    Tip: You must open this page from https://... (not a file) to use the camera. If camera fails, allow camera permissions.
  </div>

  <!-- QR scanner library (CDN) -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <script>
    const out = document.getElementById("out");
    const firstEl = document.getElementById("first");
    const lastEl  = document.getElementById("last");
    const phoneEl = document.getElementById("phone");

    function show(msg, ok=null) {
      out.textContent = msg;
      out.classList.remove("ok","bad");
      if (ok === true) out.classList.add("ok");
      if (ok === false) out.classList.add("bad");
    }

    // Build absolute URLs on the same origin (Render).
    function apiUrl(path) {
      return new URL(path, window.location.origin).toString();
    }

    // Load saved identity from localStorage.
    firstEl.value = localStorage.getItem("bjj_first") || "";
    lastEl.value  = localStorage.getItem("bjj_last")  || "";
    phoneEl.value = localStorage.getItem("bjj_phone") || "";

    // Normalize input fields into a payload.
    function getIdentity() {
      const first = (firstEl.value || "").trim();
      const last  = (lastEl.value || "").trim();
      const phone = normalizePhone(phoneEl.value || "");
      if (!first || !last) return null;
      return { first, last, phone: phone || null };
    }
    
    // Keep only digits; last 10 digits for US numbers.
    function normalizePhone(value) {
      const digits = String(value || "").replace(/\D+/g, "");
      if (!digits) return "";
      return digits.length > 10 ? digits.slice(-10) : digits;
    }

    function formatPhone(value) {
      const digits = normalizePhone(value);
      if (digits.length === 7) {
        return `${digits.slice(0,3)}-${digits.slice(3)}`;
      }
      if (digits.length === 10) {
        return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
      }
      return value || "";
    }

    phoneEl.addEventListener("input", () => {
      const formatted = formatPhone(phoneEl.value);
      phoneEl.value = formatted;
    });

    // Save identity locally for quick re-use.
    async function saveIdentity() {
      const id = getIdentity();
      if (!id) return show("‚ùå Please enter first and last name.", false);
      localStorage.setItem("bjj_first", id.first);
      localStorage.setItem("bjj_last", id.last);
      localStorage.setItem("bjj_phone", id.phone || "");
      show(`‚úÖ Saved: ${id.first} ${id.last}`, true);
    }

    // Validate membership before scanning.
    async function validateMember() {
      const id = getIdentity();
      if (!id) return show("‚ùå Please enter first and last name.", false);

      const url = apiUrl(`/members/lookup?first_name=${encodeURIComponent(id.first)}&last_name=${encodeURIComponent(id.last)}`
        + (id.phone ? `&phone=${encodeURIComponent(id.phone)}` : ""));

      show(`üîç Validating membership...\nGET ${url}`);

      let res, data;
      try {
        res = await fetch(url, { method: "GET" });
        data = await res.json();
      } catch (e) {
        return show(`‚ùå Validate failed (network/error)\n${e}`, false);
      }

      if (data.valid) {
        const m = data.member;
        show(`‚úÖ Member OK: ${m.first_name} ${m.last_name} (${m.student_type}${m.belt_rank ? ", " + m.belt_rank : ""})`, true);
      } else {
        show(`‚ùå Member not found.\nName (and phone if used) must match membership database.`, false);
      }
    }

    let html5Qr = null;
    let scanning = false;

    // Start camera + process decoded QR value.
    async function startScan() {
      const id = getIdentity();
      if (!id) return show("‚ùå Enter your name first (first + last).", false);

      // Optional validation before scan
      await validateMember();

      if (scanning) return;

      html5Qr = new Html5Qrcode("reader");
      scanning = true;

      show("üì∑ Starting camera‚Ä¶ point it at the facility QR code.");

      try {
        await html5Qr.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: { width: 250, height: 250 } },
          async (decodedText) => {
            await stopScan();

            const scanEndpoint = apiUrl("/scan");
            show(`üîé QR read: ${decodedText}\nPOST ${scanEndpoint}\nRecording check-in‚Ä¶`);

            const payload = {
              qr_value: decodedText,
              first_name: id.first,
              last_name: id.last,
              phone: id.phone || null
            };

            let res, bodyText;
            try {
              res = await fetch(scanEndpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
              });
              bodyText = await res.text(); // keep raw text so we can show it even if JSON fails
            } catch (e) {
              return show(`‚ùå POST failed (network/error)\n${e}`, false);
            }

            // Try JSON parse, but don't die if it's HTML or error text.
            let data = null;
            try { data = JSON.parse(bodyText); } catch {}

            if (!res.ok) {
              const detail = (data && (data.detail || data.message)) ? (data.detail || data.message) : bodyText;
              return show(`‚ùå Check-in failed\nHTTP ${res.status}\n${detail}`, false);
            }

            // Friendly messages
            if (data && data.status === "ok") {
              const fac = data.facility_name || data.facility_id || "facility";
              show(`‚úÖ Check-in recorded at ${fac}\n${data.member_name ? "Member: " + data.member_name : ""}`, true);
            } else if (data && data.status === "ignored") {
              show(`‚ÑπÔ∏è Already checked in recently ‚Äî ignored (15 min rule).`, true);
            } else if (data && data.status === "too_soon") {
              show(`‚è≥ Too soon ‚Äî blocked (30 min rule).`, false);
            } else {
              show(`‚úÖ Done\n${bodyText}`, true);
            }
          },
          (_err) => {
            // ignore per-frame scan errors
          }
        );
      } catch (e) {
        scanning = false;
        show(`‚ùå Camera start failed.\nAllow camera permissions.\nDetails: ${e}`, false);
      }
    }

    async function stopScan() {
      if (!html5Qr || !scanning) return;
      try { await html5Qr.stop(); } catch {}
      try { await html5Qr.clear(); } catch {}
      scanning = false;
    }
  </script>
</body>
</html>

